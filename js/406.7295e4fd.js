"use strict";(self["webpackChunkmumu"]=self["webpackChunkmumu"]||[]).push([[406],{713:function(t,e,a){var s=a(9565),i=a(9306),r=a(8551),o=a(1767),n=a(9462),l=a(6319),c=n((function(){var t=this.iterator,e=r(s(this.next,t)),a=this.done=!!e.done;if(!a)return l(t,this.mapper,[e.value,this.counter++],!0)}));t.exports=function(t){return r(this),i(t),new c(o(this),{mapper:t})}},1701:function(t,e,a){var s=a(6518),i=a(713),r=a(6395);s({target:"Iterator",proto:!0,real:!0,forced:r},{map:i})},5406:function(t,e,a){a.r(e),a.d(e,{default:function(){return p}});var s=function(){var t=this,e=t._self._c;return e("div",{staticClass:"image-marker-app"},[e("header",{staticClass:"header-bar"},[e("button",{staticClass:"back-btn",on:{click:t.goBack}},[e("svg",{attrs:{viewBox:"0 0 24 24"}},[e("path",{attrs:{d:"M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z"}})])]),e("h1",{staticClass:"header-title"},[t._v("图片标记工具")]),e("div",{staticClass:"header-placeholder"})]),e("main",{staticClass:"app-main"},[t.imageData?e("div",{staticClass:"result-area"},[e("div",{staticClass:"result-header"},[e("h3",[t._v("标记结果")]),e("button",{staticClass:"clear-btn",on:{click:t.clearAll}},[e("svg",{staticClass:"clear-icon",attrs:{viewBox:"0 0 24 24"}},[e("path",{attrs:{d:"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"}})]),t._v(" 清除重新上传 ")])]),e("div",{staticClass:"result-image-container",on:{click:t.openPreview}},[e("img",{staticClass:"result-image",attrs:{src:t.markedImage,alt:"带标记的图片"}})]),t.coordinates.length>0?e("div",{staticClass:"coordinates-result"},[e("h4",[t._v("标记点坐标")]),e("div",{staticClass:"coordinates-grid"},t._l(t.coordinates,(function(a,s){return e("div",{key:s,staticClass:"coordinate-item"},[e("span",{staticClass:"point-indicator",style:{backgroundColor:t.pointColors[s]}}),e("span",{staticClass:"point-label"},[t._v("点 "+t._s(s+1)+":")]),e("span",{staticClass:"point-coords"},[t._v("("+t._s(Math.round(a.x))+", "+t._s(Math.round(a.y))+")")])])})),0)]):t._e()]):e("div",{staticClass:"upload-area",on:{dragover:function(e){return e.preventDefault(),t.dragOver.apply(null,arguments)},dragleave:t.dragLeave,drop:function(e){return e.preventDefault(),t.handleDrop.apply(null,arguments)}}},[e("label",{staticClass:"upload-label",class:{"is-dragging":t.isDragging},on:{click:function(e){1!=t.v2&&t.getIntent()}}},[1==t.v2?e("input",{staticClass:"upload-input",attrs:{type:"file",accept:"image/jpeg,image/png,image/webp"},on:{change:t.handleFileSelect}}):t._e(),e("div",{staticClass:"upload-content"},[e("svg",{staticClass:"upload-icon",attrs:{viewBox:"0 0 24 24"}},[e("path",{attrs:{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M8,15V13H16V15H8M8,11V9H16V11H8M8,19V17H13V19H8Z"}})]),e("h3",{staticClass:"upload-title"},[t._v("选择或拖拽图片到此")]),e("p",{staticClass:"upload-hint"},[t._v("支持 JPG、PNG 或 WEBP 格式")])])])]),e("transition",{attrs:{name:"modal"}},[t.showMarkerDialog?e("div",{staticClass:"modal-mask"},[e("div",{staticClass:"modal-wrapper"},[e("div",{staticClass:"modal-container"},[e("div",{staticClass:"modal-header"},[e("h3",[t._v("图片标记")]),e("button",{staticClass:"modal-close",on:{click:t.closeDialog}},[e("svg",{attrs:{viewBox:"0 0 24 24"}},[e("path",{attrs:{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"}})])])]),e("div",{staticClass:"modal-body"},[t.showMarkerDialog?e("ImageMarker",{ref:"marker",attrs:{"image-src":t.imageData,"max-points":4},on:{"points-confirmed":t.handlePointsConfirmed,"image-saved":t.handleImageSaved,close:t.closeDialog,error:t.showNotification}}):t._e()],1)])])]):t._e()])],1),e("transition",{attrs:{name:"fade"}},[t.showPreview?e("div",{staticClass:"preview-modal",on:{click:function(e){return e.target!==e.currentTarget?null:t.closePreview.apply(null,arguments)}}},[e("div",{staticClass:"preview-content"},[e("img",{staticClass:"preview-image",attrs:{src:t.previewImage,alt:"预览图片"}}),e("button",{staticClass:"preview-close",on:{click:t.closePreview}},[e("svg",{attrs:{viewBox:"0 0 24 24"}},[e("path",{attrs:{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"}})])])])]):t._e()]),t._m(0),e("transition",{attrs:{name:"fade"}},[t.showToast?e("div",{staticClass:"toast",class:t.toastType},[e("svg",{staticClass:"toast-icon",attrs:{viewBox:"0 0 24 24"}},["success"===t.toastType?e("path",{attrs:{d:"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"}}):t._e(),"error"===t.toastType?e("path",{attrs:{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"}}):t._e()]),e("span",{staticClass:"toast-message"},[t._v(t._s(t.toastMessage))])]):t._e()])],1)},i=[function(){var t=this,e=t._self._c;return e("footer",{staticClass:"app-footer"},[e("div",{staticClass:"footer-note"},[e("p",[t._v("© 沐沐 图片标记工具")])])])}],r=(a(8111),a(1701),function(){var t=this,e=t._self._c;return e("div",{staticClass:"image-marker"},[e("div",{staticClass:"marker-header"},[e("div",{staticClass:"points-counter"},[e("span",{staticClass:"counter-badge"},[t._v(t._s(t.points.length))]),e("span",{staticClass:"counter-text"},[t._v("/"+t._s(t.maxPoints)+" 标记点")])]),e("div",{staticClass:"marker-actions"},[e("button",{staticClass:"action-btn remove-btn",attrs:{disabled:0===t.points.length},on:{click:t.removeLastPoint}},[e("svg",{staticClass:"action-icon",attrs:{viewBox:"0 0 24 24"}},[e("path",{attrs:{d:"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"}})]),t._v(" 删除 ")]),e("button",{staticClass:"action-btn reset-btn",attrs:{disabled:0===t.points.length},on:{click:t.resetPoints}},[e("svg",{staticClass:"action-icon",attrs:{viewBox:"0 0 24 24"}},[e("path",{attrs:{d:"M12,5V1L7,6L12,11V7A6,6 0 0,1 18,13A6,6 0 0,1 12,19A6,6 0 0,1 6,13H4A8,8 0 0,0 12,21A8,8 0 0,0 20,13A8,8 0 0,0 12,5Z"}})]),t._v(" 重置 ")]),e("button",{staticClass:"action-btn confirm-btn",attrs:{disabled:0===t.points.length},on:{click:t.confirmAndSave}},[e("svg",{staticClass:"action-icon",attrs:{viewBox:"0 0 24 24"}},[e("path",{attrs:{d:"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"}})]),t._v(" 完成 ")])])]),e("div",{ref:"imageContainer",staticClass:"image-container"},[e("img",{ref:"image",staticClass:"marker-image",attrs:{src:t.imageSrc,draggable:"false"},on:{load:t.imageLoaded,click:t.addPoint,touchstart:function(e){return e.preventDefault(),t.handleTouchStart.apply(null,arguments)}}}),t._l(t.points,(function(a,s){return e("div",{key:s,staticClass:"marker-point",style:{left:a.displayX+"px",top:a.displayY+"px",backgroundColor:t.pointColors[s]||"#3b82f6"},on:{mousedown:function(e){return t.startDrag(s,e)},touchstart:function(e){return t.startDrag(s,e)}}},[e("span",{staticClass:"point-number"},[t._v(t._s(s+1))])])}))],2)])}),o=[],n=(a(4114),a(7588),{name:"ImageMarker",props:{imageSrc:{type:String,required:!0,validator:t=>t.startsWith("data:image/")||t.startsWith("blob:")},maxPoints:{type:Number,default:4,validator:t=>t>0}},data(){return{points:[],naturalSize:{width:0,height:0},isDragging:!1,dragIndex:null,startX:0,startY:0,startPointX:0,startPointY:0,pointColors:["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#f97316","#84cc16"],resizeObserver:null}},methods:{calculateDisplayRect(){const t=this.$refs.image,e=this.$refs.imageContainer,a=t.getBoundingClientRect(),s=e.getBoundingClientRect(),i=window.getComputedStyle(t);let r=a.left-s.left,o=a.top-s.top,n=a.width,l=a.height;if("contain"===i.objectFit){const t=this.naturalSize.width/this.naturalSize.height,e=s.width/s.height;if(t>e){const e=s.width/t;o=(s.height-e)/2,l=e}else{const e=s.height*t;r=(s.width-e)/2,n=e}}return{x:r,y:o,width:n,height:l}},async imageLoaded(){try{await this.ensureImageLoaded();const t=this.$refs.image;this.naturalSize={width:t.naturalWidth,height:t.naturalHeight},this.initResizeObserver()}catch(t){console.error("图片加载失败:",t),this.$emit("error","图片加载失败")}},async ensureImageLoaded(){const t=this.$refs.image;if(!t.complete||0===t.naturalHeight)return new Promise(((e,a)=>{t.onload=e,t.onerror=a,setTimeout((()=>{t.naturalHeight>0?e():a(new Error("图片加载超时"))}),1e3)}))},initResizeObserver(){this.resizeObserver&&this.resizeObserver.disconnect(),this.resizeObserver=new ResizeObserver((()=>{this.recalculatePointsPosition()})),this.resizeObserver.observe(this.$refs.imageContainer),this.resizeObserver.observe(this.$refs.image)},handleTouchStart(t){this.touchStartTime=Date.now();const e=t.touches[0],a=Date.now();a-this.touchStartTime<200&&this.addPoint(e)},addPoint(t){if(this.points.length>=this.maxPoints)return void this.$emit("error",`最多只能标记 ${this.maxPoints} 个点`);const e=this.calculateDisplayRect(),a=this.$refs.imageContainer.getBoundingClientRect(),s=t.clientX??t.touches[0].clientX,i=t.clientY??t.touches[0].clientY,r=s-a.left-e.x,o=i-a.top-e.y,n=r/e.width*this.naturalSize.width,l=o/e.height*this.naturalSize.height;r<0||o<0||r>e.width||o>e.height||(this.points.push({displayX:r+e.x,displayY:o+e.y,naturalX:n,naturalY:l}),this.$emit("points-updated",this.getNaturalPoints()))},startDrag(t,e){this.isDragging=!0,this.dragIndex=t;const a=e.clientX??e.touches[0].clientX,s=e.clientY??e.touches[0].clientY;this.startX=a,this.startY=s,this.startPointX=this.points[t].displayX,this.startPointY=this.points[t].displayY,e.preventDefault(),document.addEventListener("mousemove",this.dragPoint),document.addEventListener("mouseup",this.stopDrag),document.addEventListener("touchmove",this.dragPoint,{passive:!1}),document.addEventListener("touchend",this.stopDrag)},dragPoint(t){if(!this.isDragging)return;t.preventDefault();const e=this.calculateDisplayRect(),a=t.clientX??t.touches[0].clientX,s=t.clientY??t.touches[0].clientY,i=(this.$refs.imageContainer.getBoundingClientRect(),a-this.startX),r=s-this.startY;let o=this.startPointX+i,n=this.startPointY+r;o=Math.max(e.x,Math.min(o,e.x+e.width)),n=Math.max(e.y,Math.min(n,e.y+e.height));const l=o-e.x,c=n-e.y,h=l/e.width*this.naturalSize.width,d=c/e.height*this.naturalSize.height;this.$set(this.points,this.dragIndex,{displayX:o,displayY:n,naturalX:h,naturalY:d}),this.$emit("points-updated",this.getNaturalPoints())},stopDrag(){this.isDragging=!1,document.removeEventListener("mousemove",this.dragPoint),document.removeEventListener("mouseup",this.stopDrag),document.removeEventListener("touchmove",this.dragPoint),document.removeEventListener("touchend",this.stopDrag)},recalculatePointsPosition(){const t=this.calculateDisplayRect();this.points.forEach((e=>{e.displayX=e.naturalX/this.naturalSize.width*t.width+t.x,e.displayY=e.naturalY/this.naturalSize.height*t.height+t.y}))},removeLastPoint(){this.points.pop(),this.$emit("points-updated",this.getNaturalPoints())},resetPoints(){this.points=[],this.$emit("points-updated",[])},getNaturalPoints(){return this.points.map((t=>({x:Math.round(t.naturalX),y:Math.round(t.naturalY)})))},async confirmAndSave(){try{const t=this.getNaturalPoints();this.$emit("points-confirmed",t);const e=await this.generateImageWithPoints();this.$emit("image-saved",e),this.$emit("close")}catch(t){console.error("保存失败:",t),this.$emit("error","生成带标记的图片失败")}},generateImageWithPoints(){return new Promise((t=>{const e=document.createElement("canvas");e.width=this.naturalSize.width,e.height=this.naturalSize.height;const a=e.getContext("2d"),s=new Image;s.onload=()=>{a.drawImage(s,0,0,e.width,e.height),this.points.forEach(((t,s)=>{const i=Math.max(8,.015*Math.min(e.width,e.height));a.beginPath(),a.arc(t.naturalX,t.naturalY,i,0,2*Math.PI),a.fillStyle=this.pointColors[s],a.fill();const r=Math.max(12,.7*i);a.font=`bold ${r}px Arial`,a.textAlign="center",a.textBaseline="middle",a.fillStyle="white",a.fillText((s+1).toString(),t.naturalX,t.naturalY)})),t(e.toDataURL("image/png",1))},s.onerror=()=>{throw new Error("图片加载失败")},s.src=this.imageSrc}))}},beforeDestroy(){this.resizeObserver&&this.resizeObserver.disconnect()}}),l=n,c=a(1656),h=(0,c.A)(l,r,o,!1,null,"5c2af6e8",null),d=h.exports,g={name:"ImageMarkerTool",components:{ImageMarker:d},data(){return{v2:this.$globalConfig.v2,imageData:"",markedImage:"",coordinates:[],showMarkerDialog:!1,isDragging:!1,showToast:!1,toastMessage:"",toastType:"success",pointColors:["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#f97316","#84cc16"],showPreview:!1,previewImage:""}},mounted(){1!=this.v2&&(window.handleImageResult=this.handleAutoJsCall)},methods:{goBack(){this.$goBackOrHome()},openPreview(){this.markedImage&&(this.previewImage=this.markedImage,this.showPreview=!0,document.body.style.overflow="hidden")},closePreview(){this.showPreview=!1,document.body.style.overflow=""},handleFileSelect(t){const e=t.target.files[0];e&&this.processImageFile(e)},handleDrop(t){this.isDragging=!1;const e=t.dataTransfer.files[0];e&&this.processImageFile(e)},dragOver(){this.isDragging=!0},dragLeave(){this.isDragging=!1},processImageFile(t){if(!t.type.match(/image\/(jpeg|png|webp)/))return void this.showNotification("请选择JPG、PNG或WEBP格式的图片","error");if(t.size>5242880)return void this.showNotification("图片大小不能超过5MB","error");const e=new FileReader;e.onload=t=>{this.imageData=t.target.result,this.showMarkerDialog=!0},e.onerror=()=>{this.showNotification("图片加载失败","error")},e.readAsDataURL(t)},getIntent(){window.Android.invoke("bitmapIntent",{msg:"打开文件选择器"},(t=>{}))},handleAutoJsCall(t){200==t.code&&(this.imageData=t.base64,this.showMarkerDialog=!0)},handlePointsConfirmed(t){this.coordinates=t.map((t=>({x:Math.round(t.x),y:Math.round(t.y)})))},handleImageSaved(t){this.markedImage=t,this.closeDialog(),this.showNotification("标记完成","success")},closeDialog(){this.showMarkerDialog=!1},clearAll(){this.imageData="",this.markedImage="",this.coordinates=[],this.previewImage=""},showNotification(t,e="success"){this.toastMessage=t,this.toastType=e,this.showToast=!0,setTimeout((()=>{this.showToast=!1}),3e3)}}},u=g,m=(0,c.A)(u,s,i,!1,null,"d6ef344c",null),p=m.exports},7588:function(t,e,a){var s=a(6518),i=a(2652),r=a(9306),o=a(8551),n=a(1767);s({target:"Iterator",proto:!0,real:!0},{forEach:function(t){o(this),r(t);var e=n(this),a=0;i(e,(function(e){t(e,a++)}),{IS_RECORD:!0})}})}}]);
//# sourceMappingURL=406.7295e4fd.js.map